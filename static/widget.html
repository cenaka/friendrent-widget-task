<!DOCTYPE html>
<html>
    <head>
        <title>Аренда недвижимости</title>
        <meta charset="utf-8">
        <link href="css/style.css" rel="stylesheet"/>
    </head>
    <body>
        <p class="filterValue">Все города</p>
        <a href="#options" id="optionsLink" class="popup">изменить</a>
        <div id="ads">
            <button id="moreButton">Больше</button>
        </div>

        <div id="options">
            <div class="filterForm">
                <h1 class="title">Настройки</h1>

                <form action="" method="post" class="filterForm">
                    <select class="cities_list">
                        <option selected="selected">Выберите город</option>
                        <option>Москва</option>
                        <option>Санкт-Петербург</option>
                        <option>Нижний Новгород</option>
                        <option>Казань</option>
                        <option>Ростов-на-Дону</option>
                        <option>Волгоград</option>
                        <option>Краснодар</option>
                        <option>Саратов</option>
                        <option>Самара</option>
                        <option>Екатеринбург</option>
                        <option>Челябинск</option>
                        <option>Омск</option>
                        <option>Новосибирск</option>
                        <option>Красноярск</option>
                        <option>Пермь</option>
                        <option>Уфа</option>
                    </select>

                    <div class="priceNumber">
                        <input type="text" id="priceFrom" name="priceFrom" onfocus="checkTextInputHint(this);"
                               onblur="checkEmptyTextInput(this, 'Цена от');" value="Цена от" class="hintInput">
                        <input type="text" id="priceTo" name="priceTo" onfocus="checkTextInputHint(this);"
                               onblur="checkEmptyTextInput(this, 'до');" value="до" class="hintInput">
                    </div>
                    <div class="housingType">
                        <input type="checkbox" name="room" value="room" id='room'>
                        <label for="room">комната</label>
                        <input type="checkbox" name="flat" value="flat" id="flat">
                        <label for="flat">квартира</label>
                    </div>
                    <input type="button" id="reset" value="Сбросить" onclick="resetForm()">
                    <input type="button" id="submitButton" value="Применить" onclick="submitChanges()">
                </form>
            </div>
        </div>
    </body>
    <script src="js/jquery-2.1.4.js" type="application/javascript"></script>
    <script type="text/javascript" src="js/jquery.leanModal.min.js"></script>
    <script type="application/javascript">
        $("#optionsLink").leanModal({
            closeButton: "#submitButton"
        });

        var loadAdvertises = function() {
            $.getJSON( "advertises", getParams(), function(data) {
                addSeveralAdvertises(data.advertises);
            });
        }
        $(document).ready(function() {
            $('#moreButton').click(loadAdvertises);
            loadAdvertises();
        });

        function getParams() {
            result = {};
            if ($('.cities_list').val() !== 'Выберите город') {
                result.city = $('.cities_list').val();
            }
            if ($('#priceFrom').val() !== "Цена от") {
                result.priceFrom = $('#priceFrom').val();
            }
            if ($('#priceTo').val() !== "до") {
                result.priceTo = $('#priceTo').val();
            }
            if ($('#room').is(':checked') && !($('#flat').is(':checked'))) {
                result.type = 'room'
            } else if (!$('#room').is(':checked') && ($('#flat').is(':checked'))) {
                result.type = 'flat'
            }
            return result
        }
        function createDivElement(className, textContent) {
            var newDivElement = document.createElement('div');
            newDivElement.className = className;
            newDivElement.textContent = textContent;
            return newDivElement;
        }
        function createAElement(target, url, textContent) {
            var newAElement = document.createElement('a');
            newAElement.target = target;
            newAElement.href = url;
            newAElement.textContent = textContent;
            return newAElement;

        }
        function housingTypeConversion(serverType) {
            if (serverType === 'FLAT') {
                return ('Квартира');
            } else if (serverType === 'ROOM') {
                return ('Комната');
            } else {
                return ('??????')
            }
        }

        function addAdvertise(advertise) {
            var list = document.getElementById("ads");
            var newHTMLAddvertise = document.createElement('div');
            newHTMLAddvertise.className = 'advertise';
            var type = createAElement('_blank', advertise.url, housingTypeConversion(advertise.type));
            var price = createDivElement('price', advertise.price + ' ₽');
            var desc = createDivElement('description', advertise.desc);
            var time = createDivElement('time', new Date(advertise.time).toLocaleString("ru"));
            newHTMLAddvertise.appendChild(type);
            newHTMLAddvertise.appendChild(price);
            newHTMLAddvertise.appendChild(desc);
            newHTMLAddvertise.appendChild(time);
            list.insertBefore(newHTMLAddvertise, document.getElementById("moreButton"));
        }
        function addSeveralAdvertises(advertises) {
            for (var i = 0; i < advertises.length; i++) {
                addAdvertise(advertises[i]);
            }
        }


        function checkTextInputHint(element) {
            if (element.className == 'hintInput') {
                element.value='';
                element.className = '';
            }
        }

        function checkEmptyTextInput(element, hintText) {
            if (element.value === '' && element.className != 'hintInput') {
                element.value = hintText;
                element.className = 'hintInput';
            }
        }
        function makeTextInputHint(element, hintText) {
            element.value = hintText;
            element.className = 'hintInput';
        }
        function resetForm() {
            $('#room, #flat').val('').attr('checked', false);
            $('select option:first').attr('selected','1');
            makeTextInputHint(document.getElementById("priceFrom"), 'Цена от');
            makeTextInputHint(document.getElementById("priceTo"), 'до');
        }
        function submitChanges() {
            var result = "";
            if ($('#room').is(':checked') && !($('#flat').is(':checked'))) {
                result += "Комната, "
            } else if (!$('#room').is(':checked') && ($('#flat').is(':checked'))) {
                result += "Квартира, "
            }
            if ($('.cities_list').val() === 'Выберите город') {
                result += "Все города"
            } else {
                result += $('.cities_list').val();
            }
            if ($('#priceFrom').val() !== 'Цена от') {
                result += ' от ' + $('#priceFrom').val() + ' ₽';
            }
            if ($('#priceTo').val() !== 'до') {
                result += ' до ' + $('#priceTo').val() + ' ₽';
            }
            $('.filterValue').text(result);
            $('#ads').children().not('#moreButton').remove();
            loadAdvertises();

        }

    </script>
</html>